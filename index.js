var fs = require("fs");
var http = require("http");
var Promise = require("bluebird");
var bodyParser = require("body-parser");
var express = require("express");
var timerdaemon = require("timerdaemon");
var cors = require("cors");
var pathExists = require("path-exists");
var Io = require("socket.io");
var hwrestart = require('hwrestart');
var systemId = require('system-id');
var mkdirp = require('mkdir-p');
var rpj = require('request-promise-json');
var execSync = require('exec-sync');
var PDB = require('pouchdb');
var mqtt = require('mqtt');
var linetw = require("linetwork");
var iologin = require('./modules/socket/iologin');
var tasker = require('./modules/tasker');
var conf = require('./conf.json');
if (!pathExists.sync(__dirname + '/db')) {
    mkdirp.sync(__dirname + '/db');
}
else {
    execSync('rm -rf ' + __dirname + '/db/status/*');
}
var app = express();
var PouchDB = PDB.defaults({ prefix: './db/', auto_compaction: true });
app.use(cors());
var server = http.createServer(app);
var ioServer = Io.listen(server);
var Internet = new linetw(conf.network);
app.use('/db', require('express-pouchdb')(PouchDB));
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());
var Tasker = new tasker('http://127.0.0.1:' + conf.app.port);
Tasker.setsockethost(ioServer);
var statusdb = new PouchDB('status');
var configdb = new PouchDB('config');
var offlinedb = false;
Tasker.setdb("http://127.0.0.1:" + conf.app.port, PouchDB);
var sysId = new systemId({ path: __dirname + '/systemid', tracker: true });
app.get('/', function (req, res) {
    res.sendFile(__dirname + '/html/index.html');
});
app.get('/test', function (req, res) {
    console.log('test');
    Tasker.broadcast('test', { tt: 'rr' });
    res.json({ t: 'test' });
});
app.post('/send', function (req, res) {
    Tasker.send(req.body.task, req.body.data);
    res.json({ t: 'test' });
});
app.post('/push', function (req, res) {
    Tasker.push(req.body);
    res.json({ t: 'test' });
});
app.post('/broadcast', function (req, res) {
    Tasker.broadcast(req.body.task, req.body.data);
    res.json({ t: 'test' });
});
app.post('/save', function (req, res) {
    res.json({ t: 'test' });
});
app.post('/set', function (req, res) {
});
if (pathExists.sync(__dirname + '/systemid/.tracker')) {
}
else {
    throw Error('provide tracker first');
}
if (!pathExists.sync(__dirname + '/apps')) {
    mkdirp.sync(__dirname + '/apps');
    mkdirp.sync(__dirname + '/apps/configs');
    mkdirp.sync(__dirname + '/apps/modules');
}
else {
    if (!pathExists.sync(__dirname + '/apps/configs')) {
        mkdirp.sync(__dirname + '/apps/configs');
    }
    if (!pathExists.sync(__dirname + '/apps/modules')) {
        mkdirp.sync(__dirname + '/apps/modules');
    }
}
var apps = fs.readdirSync('./apps/modules/');
for (var m = 0; m < apps.length; m++) {
    if (pathExists.sync(__dirname + '/apps/modules/' + apps[m] + '/package.json')) {
        var appconf = require(__dirname + '/apps/modules/' + apps[m] + '/package.json');
        var appname = appconf.name;
        console.log('configuring app ' + appconf.name);
        if (pathExists.sync(__dirname + '/apps/configs/' + apps[m] + '.json')) {
            var appopts = require(__dirname + '/apps/configs/' + apps[m] + '.json');
            app.use('/' + appopts.route, require(__dirname + '/apps/modules/' + apps[m] + '/' + appconf.main)(appopts.options));
        }
        else {
            app.use('/' + appopts.route, require(__dirname + '/apps/modules/' + apps[m] + '/' + appconf.main));
        }
        if (appopts.boot) {
            setTimeout(function () {
                if (appopts.boot.object) {
                    rpj.post("http://127.0.0.1:" + conf.app.port + '/' + appopts.route + '/' + appopts.boot.path, appopts.boot.object).then(function () {
                        console.log('boot app ' + apps[m]);
                    }).catch(function (err) {
                        console.log(err);
                        console.log('error on boot app ' + appname);
                    });
                }
                else {
                    rpj.post("http://127.0.0.1:" + conf.app.port + '/' + appopts.route + appopts.boot.path).then(function () {
                        console.log('boot app ' + apps[m]);
                    }).catch(function (err) {
                        console.log(err);
                        console.log('error on boot app ' + appname);
                    });
                }
            }, 2000);
        }
    }
}
function onlinestatus() {
    var timenow = new Date().getTime();
    var obj = {
        _id: "connection",
        connected: connection,
        updatedAt: timenow
    };
    return new Promise(function (resolve, reject) {
        statusdb.get(obj._id).then(function (d) {
            obj._rev = d._rev;
            if (!connection && !d.from) {
                obj.from = timenow;
            }
            else if (!connection && d.from && d.from < (timenow - 10000)) {
                console.log(d.from, (timenow - 10000));
                hwrestart('unplug');
            }
            statusdb.put(obj).then(function () {
                resolve(obj);
            }).catch(function (err) {
                reject(err);
            });
        }).catch(function (e) {
            if (e.status == 404) {
                if (!connection) {
                    obj.from = timenow;
                }
                statusdb.post(obj).then(function () {
                    resolve(obj);
                }).catch(function (err) {
                    reject(err);
                    if (!connection) {
                        hwrestart('unplug');
                    }
                });
            }
            else if (!connection) {
                console.log(e);
                hwrestart('unplug');
            }
            else {
                reject(e);
            }
        });
    });
}
var firstconnection = false;
var connection = false;
var iosevents = false;
var socket;
var authorized = false;
function Connect(url, auth) {
    if (!authorized) {
        console.log('trying to connect');
        iologin(url, auth).then(function (token) {
            var mqttclient = mqtt.connect('mqtt://kernel.online', { port: 9883, username: sysId.auth().user, password: new Buffer(JSON.stringify(token), 'utf8') });
            mqttclient.on('message', function (topic, message, packet) {
                console.log(topic);
                switch (topic) {
                    case "npm":
                        break;
                    case "task":
                        Tasker.run(message);
                        break;
                    case "exec":
                        break;
                }
            });
            mqttclient.on('connect', function () {
                console.log("MQTT connected");
                Tasker.setsocketclient(socket);
                console.log('online');
                connection = true;
                if (!firstconnection) {
                    firstconnection = true;
                }
                if (!connection) {
                    connection = true;
                    onlinestatus();
                }
            });
            mqttclient.on('reconnect', function (err) {
                console.log("MQTT connected");
                Tasker.setsocketclient(socket);
                console.log('online');
                connection = true;
                if (!connection) {
                    connection = true;
                    onlinestatus();
                }
            });
            mqttclient.on('error', function (err) {
                console.log('error');
                console.log(err);
                connection = false;
                if (connection) {
                    connection = false;
                    onlinestatus();
                }
            });
            mqttclient.on('close', function (err) {
                console.log('error');
                console.log(err);
                connection = false;
                if (connection) {
                    connection = false;
                    onlinestatus();
                }
            });
            mqttclient.on('offline', function (err) {
                console.log('error');
                console.log(err);
                connection = false;
                if (connection) {
                    connection = false;
                    onlinestatus();
                }
            });
        }).catch(function (err) {
            console.log('wrooong');
            console.log(err);
            setTimeout(function () {
                Connect(url, auth);
            }, 3000);
        });
    }
}
console.log(Internet);
Internet.init().then(function (status) {
    console.log("CONNECTED");
    console.log(status);
}).catch(function (err) {
    console.log("err CONNECTED");
    console.log(err);
    hwrestart('unplug');
});
Connect(conf.io, sysId.auth());
timerdaemon.post(5000, function () {
    onlinestatus();
});
server.listen(conf.app.port, '0.0.0.0');

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbIm9ubGluZXN0YXR1cyIsIkNvbm5lY3QiXSwibWFwcGluZ3MiOiJBQUFBLElBQVksRUFBRSxXQUFNLElBQUksQ0FBQyxDQUFBO0FBQ3pCLElBQVksSUFBSSxXQUFNLE1BQU0sQ0FBQyxDQUFBO0FBRTdCLElBQVksT0FBTyxXQUFNLFVBQVUsQ0FBQyxDQUFBO0FBQ3BDLElBQVksVUFBVSxXQUFNLGFBQWEsQ0FBQyxDQUFBO0FBRTFDLElBQVksT0FBTyxXQUFNLFNBQVMsQ0FBQyxDQUFBO0FBQ25DLElBQVksV0FBVyxXQUFNLGFBQWEsQ0FBQyxDQUFBO0FBQzNDLElBQVksSUFBSSxXQUFNLE1BQU0sQ0FBQyxDQUFBO0FBQzdCLElBQVksVUFBVSxXQUFNLGFBQWEsQ0FBQyxDQUFBO0FBRzFDLElBQVksRUFBRSxXQUFNLFdBQVcsQ0FBQyxDQUFBO0FBRWhDLElBQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUN2QyxJQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7QUFFdEMsSUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ2xDLElBQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQzVDLElBQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUN0QyxJQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDL0IsSUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBRTdCLElBQU8sTUFBTSxXQUFVLFdBQVcsQ0FBQyxDQUFDO0FBTXBDLElBQU8sT0FBTyxXQUFXLDBCQUEwQixDQUFDLENBQUM7QUFFckQsSUFBTyxNQUFNLFdBQVcsa0JBQWtCLENBQUMsQ0FBQztBQUs1QyxJQUFNLElBQUksR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7QUFHcEMsRUFBRSxD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QUFDLENBQUMsQ0FBQztBQUtILE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFBO0FBRTlCLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFO0lBRW5CLFlBQVksRUFBRSxDQUFBO0FBRWxCLENBQUMsQ0FBQyxDQUFBO0FBSUYsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0ICogYXMgaHR0cCBmcm9tIFwiaHR0cFwiO1xuXG5pbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gXCJibHVlYmlyZFwiO1xuaW1wb3J0ICogYXMgYm9keVBhcnNlciBmcm9tIFwiYm9keS1wYXJzZXJcIjtcblxuaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tIFwiZXhwcmVzc1wiO1xuaW1wb3J0ICogYXMgdGltZXJkYWVtb24gZnJvbSBcInRpbWVyZGFlbW9uXCI7XG5pbXBvcnQgKiBhcyBjb3JzIGZyb20gXCJjb3JzXCI7XG5pbXBvcnQgKiBhcyBwYXRoRXhpc3RzIGZyb20gXCJwYXRoLWV4aXN0c1wiO1xuXG5pbXBvcnQgKiBhcyBpb0NsaWVudCBmcm9tIFwic29ja2V0LmlvLWNsaWVudFwiO1xuaW1wb3J0ICogYXMgSW8gZnJvbSBcInNvY2tldC5pb1wiO1xuXG5jb25zdCBod3Jlc3RhcnQgPSByZXF1aXJlKCdod3Jlc3RhcnQnKTtcbmNvbnN0IHN5c3RlbUlkID0gcmVxdWlyZSgnc3lzdGVtLWlkJyk7XG5cbmNvbnN0IG1rZGlycCA9IHJlcXVpcmUoJ21rZGlyLXAnKTtcbmNvbnN0IHJwaiA9IHJlcXVpcmUoJ3JlcXVlc3QtcHJvbWlzZS1qc29uJyk7XG5jb25zdCBleGVjU3luYyA9IHJlcXVpcmUoJ2V4ZWMtc3luYycpO1xuY29uc3QgUERCID0gcmVxdWlyZSgncG91Y2hkYicpO1xuY29uc3QgbXF0dCA9IHJlcXVpcmUoJ21xdHQnKTtcblxuaW1wb3J0IGxpbmV0dyA9cmVxdWlyZShcImxpbmV0d29ya1wiKTtcblxuLy8gdmFyIG5vT2ZmbGluZT1yZXF1aXJlKCcuL21vZHVsZXMvb2ZmbGluZWNvdW50Jyk7XG5cblxuXG5pbXBvcnQgaW9sb2dpbiA9IHJlcXVpcmUoJy4vbW9kdWxlcy9zb2NrZXQvaW9sb2dpbicpO1xuXG5pbXBvcnQgdGFza2VyID0gcmVxdWlyZSgnLi9tb2R1bGVzL3Rhc2tlcicpO1xuXG5cblxuXG5jb25zdCBjb25mID0gcmVxdWlyZSgnLi9jb25mLmpzb24nKTtcblxuXG5pZiAoIXBhdGhFeGlzdHMuc3luYyhfX2Rpcm5hbWUgKyAnL2RiJykpIHtcbiAgICBta2RpcnAuc3luYyhfX2Rpcm5hbWUgKyAnL2RiJylcbn0gZWxzZSB7XG4gICAgZXhlY1N5bmMoJ3JtIC1yZiAnK19fZGlybmFtZSArJy9kYi9zdGF0dXMvKicpXG59XG5cbmNvbnN0IGFwcCA9IGV4cHJlc3MoKTtcbmNvbnN0IFBvdWNoREIgPSBQREIuZGVmYXVsdHMoeyBwcmVmaXg6ICcuL2RiLycsIGF1dG9fY29tcGFjdGlvbjogdHJ1ZSB9KTtcbmFwcC51c2UoY29ycygpKTtcblxuXG5jb25zdCBzZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcihhcHApO1xuXG5cbmNvbnN0IGlvU2VydmVyID0gSW8ubGlzdGVuKHNlcnZlcik7XG5cbmNvbnN0IEludGVybmV0ID0gbmV3IGxpbmV0dyhjb25mLm5ldHdvcmspO1xuXG5cblxuXG5hcHAudXNlKCcvZGInLCByZXF1aXJlKCdleHByZXNzLXBvdWNoZGInKShQb3VjaERCKSk7XG4vLyBwYXJzZSBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRcbmFwcC51c2UoYm9keVBhcnNlci51cmxlbmNvZGVkKHsgZXh0ZW5kZWQ6IGZhbHNlIH0pKVxuXG4vLyBwYXJzZSBhcHBsaWNhdGlvbi9qc29uXG5hcHAudXNlKGJvZHlQYXJzZXIuanNvbigpKVxuXG5cbmNvbnN0IFRhc2tlciA9IG5ldyB0YXNrZXIoJ2h0dHA6Ly8xMjcuMC4wLjE6JyArIGNvbmYuYXBwLnBvcnQpO1xuXG5UYXNrZXIuc2V0c29ja2V0aG9zdChpb1NlcnZlcilcblxuY29uc3Qgc3RhdHVzZGIgPSBuZXcgUG91Y2hEQignc3RhdHVzJyk7XG5jb25zdCBjb25maWdkYiA9IG5ldyBQb3VjaERCKCdjb25maWcnKTtcblxubGV0IG9mZmxpbmVkYiA9IGZhbHNlO1xuXG5cblRhc2tlci5zZXRkYihcImh0dHA6Ly8xMjcuMC4wLjE6XCIgKyBjb25mLmFwcC5wb3J0LCBQb3VjaERCKVxuXG4vL2V4ZWNTeW5jKCdybSAtcmYgc3lzdGVtaWQvKicpICAvLyB0byBiZSByZW1vdmVkXG5cbmNvbnN0IHN5c0lkID0gbmV3IHN5c3RlbUlkKHsgcGF0aDogX19kaXJuYW1lICsgJy9zeXN0ZW1pZCcsIHRyYWNrZXI6IHRydWUgfSk7XG5cbi8vIHN5c0lkLnZhbGlkYXRlKHN5c0lkLnNlcmlhbCx7XG4vLyAgdXNlcjonc2xtYWNoX2luZ2NhcnVzb2FfNGl5NXRnJyxcbi8vICBwYXNzd29yZDonMmVzZ2gyN2V1MWJiJyxcbi8vICBkYjonbWFjaF9zdWZqdDVfZW5lcmd5dHJhY2snXG4vLyB9KSAvLyAhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhdG8gYmUgcmVtb3ZlZFxuXG5cbmFwcC5nZXQoJy8nLCBmdW5jdGlvbihyZXEsIHJlcykge1xuICAgIHJlcy5zZW5kRmlsZShfX2Rpcm5hbWUgKyAnL2h0bWwvaW5kZXguaHRtbCcpXG59KVxuXG5cbmFwcC5nZXQoJy90ZXN0JywgZnVuY3Rpb24ocmVxLCByZXMpIHtcbiAgICBjb25zb2xlLmxvZygndGVzdCcpXG4gICAgVGFza2VyLmJyb2FkY2FzdCgndGVzdCcsIHsgdHQ6ICdycicgfSlcblxuXG4gICAgcmVzLmpzb24oeyB0OiAndGVzdCcgfSlcbn0pXG5cbmFwcC5wb3N0KCcvc2VuZCcsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7IC8vIGludmlhIGdsaSBvZ2dldHRpIG8gbGkgc2FsdmEgc2Ugbm9uIGMnw6ggY29ubmVzc2lvbmUgZSBsaSBpbnZpYSBkb3BvXG5cbiAgICBUYXNrZXIuc2VuZChyZXEuYm9keS50YXNrLCByZXEuYm9keS5kYXRhKVxuICAgIHJlcy5qc29uKHsgdDogJ3Rlc3QnIH0pXG59KVxuYXBwLnBvc3QoJy9wdXNoJywgZnVuY3Rpb24ocmVxLCByZXMpIHsgLy8gaW52aWEgZ2xpIG9nZ2V0dGlcblxuICAgIFRhc2tlci5wdXNoKHJlcS5ib2R5KVxuXG5cbiAgICByZXMuanNvbih7IHQ6ICd0ZXN0JyB9KVxufSlcbmFwcC5wb3N0KCcvYnJvYWRjYXN0JywgZnVuY3Rpb24ocmVxLCByZXMpIHsgLy8gaW52aWEgZ2xpIG9nZ2V0dGlcblxuICAgIFRhc2tlci5icm9hZGNhc3QocmVxLmJvZHkudGFzaywgcmVxLmJvZHkuZGF0YSlcblxuXG4gICAgcmVzLmpzb24oeyB0OiAndGVzdCcgfSlcbn0pXG5hcHAucG9zdCgnL3NhdmUnLCBmdW5jdGlvbihyZXEsIHJlcykgeyAvLyBtZW1vcml6emEgaW4gbG9jYWxlXG4gICAgcmVzLmpzb24oeyB0OiAndGVzdCcgfSlcbn0pXG5hcHAucG9zdCgnL3NldCcsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7IC8vIHNhbHZhIGxvIHN0YXR1cyBzdWwgZGIgZSBsbyBpbnZpYVxuXG5cblxufSlcblxuaWYgKHBhdGhFeGlzdHMuc3luYyhfX2Rpcm5hbWUgKyAnL3N5c3RlbWlkLy50cmFja2VyJykpIHtcblxufSBlbHNlIHtcbiAgICB0aHJvdyBFcnJvcigncHJvdmlkZSB0cmFja2VyIGZpcnN0Jylcbn1cblxuXG5pZiAoIXBhdGhFeGlzdHMuc3luYyhfX2Rpcm5hbWUgKyAnL2FwcHMnKSkge1xuICAgIG1rZGlycC5zeW5jKF9fZGlybmFtZSArICcvYXBwcycpXG4gICAgbWtkaXJwLnN5bmMoX19kaXJuYW1lICsgJy9hcHBzL2NvbmZpZ3MnKVxuICAgIG1rZGlycC5zeW5jKF9fZGlybmFtZSArICcvYXBwcy9tb2R1bGVzJylcblxufSBlbHNlIHtcblxuICAgIGlmICghcGF0aEV4aXN0cy5zeW5jKF9fZGlybmFtZSArICcvYXBwcy9jb25maWdzJykpIHtcbiAgICAgICAgbWtkaXJwLnN5bmMoX19kaXJuYW1lICsgJy9hcHBzL2NvbmZpZ3MnKVxuXG4gICAgfVxuICAgIGlmICghcGF0aEV4aXN0cy5zeW5jKF9fZGlybmFtZSArICcvYXBwcy9tb2R1bGVzJykpIHtcbiAgICAgICAgbWtkaXJwLnN5bmMoX19kaXJuYW1lICsgJy9hcHBzL21vZHVsZXMnKVxuXG4gICAgfVxufVxuXG5sZXQgYXBwcyA9IGZzLnJlYWRkaXJTeW5jKCcuL2FwcHMvbW9kdWxlcy8nKVxuZm9yICh2YXIgbSA9IDA7IG0gPCBhcHBzLmxlbmd0aDsgbSsrKSB7XG4gICAgaWYgKHBhdGhFeGlzdHMuc3luYyhfX2Rpcm5hbWUgKyAnL2FwcHMvbW9kdWxlcy8nICsgYXBwc1ttXSArICcvcGFja2FnZS5qc29uJykpIHtcbiAgICAgICAgdmFyIGFwcGNvbmYgPSByZXF1aXJlKF9fZGlybmFtZSArICcvYXBwcy9tb2R1bGVzLycgKyBhcHBzW21dICsgJy9wYWNrYWdlLmpzb24nKVxuICAgICAgICB2YXIgYXBwbmFtZSA9IGFwcGNvbmYubmFtZVxuXG5cbiAgICAgICAgY29uc29sZS5sb2coJ2NvbmZpZ3VyaW5nIGFwcCAnICsgYXBwY29uZi5uYW1lKVxuXG5cbiAgICAgICAgaWYgKHBhdGhFeGlzdHMuc3luYyhfX2Rpcm5hbWUgKyAnL2FwcHMvY29uZmlncy8nICsgYXBwc1ttXSArICcuanNvbicpKSB7XG4gICAgICAgICAgICB2YXIgYXBwb3B0cyA9IHJlcXVpcmUoX19kaXJuYW1lICsgJy9hcHBzL2NvbmZpZ3MvJyArIGFwcHNbbV0gKyAnLmpzb24nKVxuXG4gICAgICAgICAgICBhcHAudXNlKCcvJyArIGFwcG9wdHMucm91dGUsIHJlcXVpcmUoX19kaXJuYW1lICsgJy9hcHBzL21vZHVsZXMvJyArIGFwcHNbbV0gKyAnLycgKyBhcHBjb25mLm1haW4pKGFwcG9wdHMub3B0aW9ucykpO1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhcHAudXNlKCcvJyArIGFwcG9wdHMucm91dGUsIHJlcXVpcmUoX19kaXJuYW1lICsgJy9hcHBzL21vZHVsZXMvJyArIGFwcHNbbV0gKyAnLycgKyBhcHBjb25mLm1haW4pKTtcblxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFwcG9wdHMuYm9vdCkge1xuICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcblxuICAgICAgICAgICAgICAgIGlmIChhcHBvcHRzLmJvb3Qub2JqZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgIHJwai5wb3N0KFwiaHR0cDovLzEyNy4wLjAuMTpcIiArIGNvbmYuYXBwLnBvcnQgKyAnLycgKyBhcHBvcHRzLnJvdXRlICsgJy8nICsgYXBwb3B0cy5ib290LnBhdGgsIGFwcG9wdHMuYm9vdC5vYmplY3QpLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnYm9vdCBhcHAgJyArIGFwcHNbbV0pXG4gICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKVxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2Vycm9yIG9uIGJvb3QgYXBwICcgKyBhcHBuYW1lKVxuXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcnBqLnBvc3QoXCJodHRwOi8vMTI3LjAuMC4xOlwiICsgY29uZi5hcHAucG9ydCArICcvJyArIGFwcG9wdHMucm91dGUgKyBhcHBvcHRzLmJvb3QucGF0aCkudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdib290IGFwcCAnICsgYXBwc1ttXSlcbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnZXJyb3Igb24gYm9vdCBhcHAgJyArIGFwcG5hbWUpXG5cbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LCAyMDAwKVxuXG4gICAgICAgIH1cblxuXG5cbiAgICB9XG59XG5cblxuXG5pbnRlcmZhY2Ugb25saW5lc3RhdHVzIHtcbiAgICBfaWQ6IHN0cmluZztcbiAgICBjb25uZWN0ZWQ6IGJvb2xlYW47XG4gICAgdXBkYXRlZEF0OiBudW1iZXI7XG4gICAgX3Jldj86IHN0cmluZztcbiAgICBmcm9tPzogbnVtYmVyO1xufVxuXG5mdW5jdGlvbiBvbmxpbmVzdGF0dXMoKSB7XG5cblxuICAgIGxldCB0aW1lbm93ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG5cbiAgICBsZXQgb2JqOiBvbmxpbmVzdGF0dXMgPSB7XG4gICAgICAgIF9pZDogXCJjb25uZWN0aW9uXCIsXG4gICAgICAgIGNvbm5lY3RlZDogY29ubmVjdGlvbixcbiAgICAgICAgdXBkYXRlZEF0OiB0aW1lbm93XG4gICAgfVxuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcblxuXG5cblxuICAgICAgICBzdGF0dXNkYi5nZXQob2JqLl9pZCkudGhlbihmdW5jdGlvbihkKSB7XG5cbiAgICAgICAgICAgIG9iai5fcmV2ID0gZC5fcmV2O1xuXG4gICAgICAgICAgICBpZiAoIWNvbm5lY3Rpb24gJiYgIWQuZnJvbSkge1xuICAgICAgICAgICAgICAgIG9iai5mcm9tID0gdGltZW5vdztcblxuICAgICAgICAgICAgfSBlbHNlIGlmICghY29ubmVjdGlvbiAmJiBkLmZyb20gJiYgZC5mcm9tIDwgKHRpbWVub3cgLSAxMDAwMCkpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhkLmZyb20sICh0aW1lbm93IC0gMTAwMDApKVxuICAgICAgICAgICAgICAgIGh3cmVzdGFydCgndW5wbHVnJylcbiAgICAgICAgICAgIH1cblxuXG4gICAgICAgICAgICBzdGF0dXNkYi5wdXQob2JqKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIHJlc29sdmUob2JqKVxuXG4gICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgfSlcblxuXG5cbiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZSkge1xuXG4gICAgICAgICAgICBpZiAoZS5zdGF0dXMgPT0gNDA0KSB7XG4gICAgICAgICAgICAgICAgaWYgKCFjb25uZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIG9iai5mcm9tID0gdGltZW5vdztcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBzdGF0dXNkYi5wb3N0KG9iaikudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShvYmopXG5cbiAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFjb25uZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBod3Jlc3RhcnQoJ3VucGx1ZycpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSBlbHNlIGlmICghY29ubmVjdGlvbikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpXG4gICAgICAgICAgICAgICAgaHdyZXN0YXJ0KCd1bnBsdWcnKVxuICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgIHJlamVjdChlKVxuXG4gICAgICAgICAgICB9XG5cblxuICAgICAgICB9KVxuXG5cblxuXG4gICAgfSlcblxuXG5cbn1cblxuXG5cblxubGV0IGZpcnN0Y29ubmVjdGlvbiA9IGZhbHNlXG5sZXQgY29ubmVjdGlvbiA9IGZhbHNlXG5sZXQgaW9zZXZlbnRzID0gZmFsc2VcbmxldCBzb2NrZXQ7XG5sZXQgYXV0aG9yaXplZCA9IGZhbHNlO1xuXG5mdW5jdGlvbiBDb25uZWN0KHVybDogc3RyaW5nLCBhdXRoOiBzdHJpbmcpIHtcblxuXG5cblxuICAgIGlmICghYXV0aG9yaXplZCkge1xuXG5cbiAgICAgICAgY29uc29sZS5sb2coJ3RyeWluZyB0byBjb25uZWN0JylcbiAgICAgICAgaW9sb2dpbih1cmwsIGF1dGgpLnRoZW4oZnVuY3Rpb24odG9rZW4pIHtcblxuXG5cblxuXG5cbiAgICAgICAgICAgIC8vIHRvIHRyeSBmaXJzdFxuICAgICAgICAgICAgY29uc3QgbXF0dGNsaWVudCA9IG1xdHQuY29ubmVjdCgnbXF0dDovL2tlcm5lbC5vbmxpbmUnLCB7IHBvcnQ6IDk4ODMsIHVzZXJuYW1lOiBzeXNJZC5hdXRoKCkudXNlciwgcGFzc3dvcmQ6IG5ldyBCdWZmZXIoSlNPTi5zdHJpbmdpZnkodG9rZW4pLCAndXRmOCcpIH0pO1xuXG5cblxuICAgICAgICAgICAgbXF0dGNsaWVudC5vbignbWVzc2FnZScsIGZ1bmN0aW9uKHRvcGljLCBtZXNzYWdlLCBwYWNrZXQpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyh0b3BpYyk7XG4gICAgICAgICAgICAgICAgc3dpdGNoICh0b3BpYykge1xuICAgICAgICAgICAgICAgICAgICBjYXNlIFwibnBtXCI6XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgICAgICAgICBjYXNlIFwidGFza1wiOlxuICAgICAgICAgICAgICAgICAgICAgICAgVGFza2VyLnJ1bihtZXNzYWdlKVxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgICAgICAgICAgY2FzZSBcImV4ZWNcIjpcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cblxuXG5cblxuXG4gICAgICAgICAgICB9KVxuXG5cblxuXG5cbiAgICAgICAgICAgIG1xdHRjbGllbnQub24oJ2Nvbm5lY3QnLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIk1RVFQgY29ubmVjdGVkXCIpXG5cblxuICAgICAgICAgICAgICAgIFRhc2tlci5zZXRzb2NrZXRjbGllbnQoc29ja2V0KVxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdvbmxpbmUnKVxuICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24gPSB0cnVlXG4gICBcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIWZpcnN0Y29ubmVjdGlvbikge1xuICAgICAgICAgICAgICAgICAgICBmaXJzdGNvbm5lY3Rpb24gPSB0cnVlXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY29ubmVjdGlvbikge1xuICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uID0gdHJ1ZVxuICAgICAgICAgICAgICAgICAgICBvbmxpbmVzdGF0dXMoKVxuICAgICAgICAgICAgICAgIH1cblxuXG5cblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIG1xdHRjbGllbnQub24oJ3JlY29ubmVjdCcsIGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiTVFUVCBjb25uZWN0ZWRcIilcblxuXG4gICAgICAgICAgICAgICAgVGFza2VyLnNldHNvY2tldGNsaWVudChzb2NrZXQpXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ29ubGluZScpXG4gICAgICAgICAgICAgICAgY29ubmVjdGlvbiA9IHRydWVcbiAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbm5lY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbiA9IHRydWVcbiAgICAgICAgICAgICAgICAgICAgb25saW5lc3RhdHVzKClcbiAgICAgICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgfSk7XG5cblxuXG5cbiAgICAgICAgICAgIG1xdHRjbGllbnQub24oJ2Vycm9yJywgZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2Vycm9yJylcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpXG4gICAgICAgICAgICAgICAgY29ubmVjdGlvbiA9IGZhbHNlXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbm5lY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbiA9IGZhbHNlXG4gICAgICAgICAgICAgICAgICAgIG9ubGluZXN0YXR1cygpXG4gICAgICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgIH0pO1xuXG5cbiAgICAgICAgICAgIG1xdHRjbGllbnQub24oJ2Nsb3NlJywgZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2Vycm9yJylcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpXG4gICAgICAgICAgICAgICAgY29ubmVjdGlvbiA9IGZhbHNlXG5cblxuICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29ubmVjdGlvbikge1xuICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uID0gZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgb25saW5lc3RhdHVzKClcbiAgICAgICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIG1xdHRjbGllbnQub24oJ29mZmxpbmUnLCBmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnZXJyb3InKVxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycilcbiAgICAgICAgICAgICAgICBjb25uZWN0aW9uID0gZmFsc2VcblxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb25uZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24gPSBmYWxzZVxuICAgICAgICAgICAgICAgICAgICBvbmxpbmVzdGF0dXMoKVxuICAgICAgICAgICAgICAgIH1cblxuXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCd3cm9vb25nJylcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycilcbiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgQ29ubmVjdCh1cmwsIGF1dGgpXG4gICAgICAgICAgICB9LCAzMDAwKVxuXG5cblxuICAgICAgICB9KVxuXG4gICAgfVxufVxuXG5cbmNvbnNvbGUubG9nKEludGVybmV0KTtcbkludGVybmV0LmluaXQoKS50aGVuKGZ1bmN0aW9uIChzdGF0dXMpIHtcbiAgICBjb25zb2xlLmxvZyhcIkNPTk5FQ1RFRFwiKVxuICAgICAgICBjb25zb2xlLmxvZyhzdGF0dXMpXG5cblxufSkuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICBjb25zb2xlLmxvZyhcImVyciBDT05ORUNURURcIilcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycilcbiAgICBcbiAgICAgICAgICAgICAgICBod3Jlc3RhcnQoJ3VucGx1ZycpXG5cbn0pO1xuXG5cblxuXG5Db25uZWN0KGNvbmYuaW8sIHN5c0lkLmF1dGgoKSlcblxudGltZXJkYWVtb24ucG9zdCg1MDAwLCBmdW5jdGlvbigpIHtcblxuICAgIG9ubGluZXN0YXR1cygpXG5cbn0pXG5cblxuXG5zZXJ2ZXIubGlzdGVuKGNvbmYuYXBwLnBvcnQsICcwLjAuMC4wJyk7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
